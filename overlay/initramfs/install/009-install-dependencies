#!/bin/sh
set -euo pipefail

echo "[install-dependencies] Instalando dependencias APK"
sleep 0.5

echo "Copiando archivo resolv.conf y asignando sus permisos"
sleep 0.5

cp /etc/resolv.conf "$TARGET_DISK_DIR"/etc/
chmod 644 "$TARGET_DISK_DIR"/etc/resolv.conf

echo "Creando base de datos y world de apk-tools"
sleep 0.5

mkdir -p $TARGET_DISK_DIR/var/lib/apk/db
touch    $TARGET_DISK_DIR/var/lib/apk/db/installed
chmod 644 $TARGET_DISK_DIR/var/lib/apk/db/installed

mkdir -p $TARGET_DISK_DIR/etc/apk
touch    $TARGET_DISK_DIR/etc/apk/world
chmod 644 $TARGET_DISK_DIR/etc/apk/world

echo "-Actualizando keys del initramfs a rootfs"
sleep 0.5

mkdir -p $TARGET_DISK_DIR/etc/apk/keys
cp /etc/apk/keys/* $TARGET_DISK_DIR/etc/apk/keys

echo "Actualizando base de datos"
apk update --root $TARGET_DISK_DIR

echo "Descargando e instalando paquetes"
apk add --root $TARGET_DISK_DIR
  apk-tools \
  shadow \
  dhcpcd \
  openresolv \
  util-linux \
  strace \
  openssh \
  grub-efi \
  parted \
  sdl2-dev sdl2 \
  libdrm \
  libdrm-dev \
  mesa-gbm \
  mesa-dev \
  linux-headers \
  mesa-dri-gallium \
  libinput-dev \
  expat-dev libffi-dev

echo "[install-dependencies] Instalaci√≥n de dependencias APK terminada"
sleep 0.5