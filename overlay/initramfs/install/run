#!/bin/sh
set -euo pipefail

SCRIPT_NAME=$0
SCRIPTS_DIR="$(dirname "$0")"

. "$SCRIPTS_DIR/globals-definitions"
. "$SCRIPTS_DIR/util-log"

log_message "$SCRIPT_NAME" "Iniciando ejecución de scripts de instalación"

# Ejecutar un único script directo
if [ -n "${1-}" ] && [ "${1%%=*}" != "skip" ]; then
  script="$1"
  log_message "$SCRIPT_NAME" "Ejecutando script único: $script"
  sh "$script"
  exit 0
fi

i=0
while :; do
  prefix=$(printf "%04d" "$i")
  found_any=false

  for script in "$SCRIPTS_DIR/${prefix}"-*; do
    [ -f "$script" ] || continue
    found_any=true

    if [ ! -x "$script" ]; then
      log_message "$SCRIPT_NAME" "Ejecutando $script con sh"
      sh "$script"
    else
      log_message "$SCRIPT_NAME" "Ejecutando $script"
      "$script"
    fi
  done

  if [ "$found_any" = false ]; then
    log_message "$SCRIPT_NAME" "No se encontraron más scripts para el prefijo $prefix. Finalizando."
    break
  fi

  i=$((i + 1))
done

log_message "$SCRIPT_NAME" "Todos los scripts se ejecutaron correctamente"
exit 0
