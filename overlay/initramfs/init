#!/bin/sh
set -euo pipefail

# Script init para initramfs de WolfbearOS
# Monta la partición, comprueba la instalación y lanza instalador si es necesario

echo "[initramfs] Arrancando sistemas virtuales..."
mkdir -p /proc /sys /dev
mount -t devtmpfs dev /dev
mount -t proc proc /proc
mount -t sysfs sysfs /sys

# Definir punto de montaje
defined_mnt="/mnt/sda-root"
mkdir -p "$defined_mnt"

export WOLFBEAR_PRODUCT_NAME=$(cat /sys/class/dmi/id/product_name 2>/dev/null | tr -d '\r')
export WOLFBEAR_SYS_VENDOR=$( cat /sys/class/dmi/id/sys_vendor )
export WOLFBEAR_PARTITION_TIMEOUT=10
export WOLFBEAR_SDA_ROOT_DIR="/mnt/sda-root"

export WOLFBEAR_DISK_LABEL=$(blkid "$WOLFBEAR_ROOTFS_DISK" | sed -n 's/.*LABEL="\([^"]*\)".*/\1/p')

case "$WOLFBEAR_PRODUCT_NAME" in
    *QEMU*|*KVM*|*VirtualBox*|*VMware*|*Bochs*|*Xen*|*Hyper-V*|*Parallels*|*Apple\ Virtual*)
        export WOLFBEAR_IS_VIRTUALIZED="true"
        ;;
    *)
        export WOLFBEAR_IS_VIRTUALIZED="false"
        ;;
esac

case "$WOLFBEAR_DISK_LABEL" in
    WBI_*)
        export WOLFBEAR_DISK="/dev/sda"
        ;;
    *)
        if [ "$WOLFBEAR_IS_VIRTUALIZED" = "true" ]; then
            export WOLFBEAR_DISK="/dev/vda"
        else
            export WOLFBEAR_DISK="/dev/sda"
        fi
        ;;
esac

WOLFBEAR_DISK_PARTITION=$WOLFBEAR_DISK"2"

echo "WolfbearOS System Properties"
echo "product name:     $WOLFBEAR_PRODUCT_NAME"
echo "system vendor:    $WOLFBEAR_SYS_VENDOR"
echo "is virtualized:   $WOLFBEAR_IS_VIRTUALIZED"
echo "sda-root disk:    $WOLFBEAR_DISK"
echo "sda-root dir:     $WOLFBEAR_SDA_ROOT_DIR"
echo "disk-label:       $WOLFBEAR_DISK_LABEL"

echo "Listando bloques"
lsblk

echo "Esperando que $WOLFBEAR_DISK esté disponible..."

for i in $(seq 1 $WOLFBEAR_PARTITION_TIMEOUT); do
  if [ -b "$WOLFBEAR_DISK" ]; then
    echo "$WOLFBEAR_DISK está listo."
    break
  fi
  echo "Intento $i: $WOLFBEAR_DISK aún no está disponible. Esperando..."
  sleep 1
done

if [ ! -b "$WOLFBEAR_DISK" ]; then
  echo "[ERROR] $WOLFBEAR_DISK no apareció tras $WOLFBEAR_PARTITION_TIMEOUT segundos. Abortando."
  exit 1
fi

mkdir -p $WOLFBEAR_SDA_ROOT_DIR
# Intento de montaje
if mount "$WOLFBEAR_DISK_PARTITION" "$WOLFBEAR_SDA_ROOT_DIR"; then
    sleep 0.5
    # Si está instalado, lanzamos el sistema
    if [ -f "$defined_mnt/.wolfbearOSInstalled" ]; then
        echo "[initramfs] WolfbearOS detectado. Iniciando sistema.."
        sh /launch/run || echo "[initramfs] Error al iniciar el sistema."
    else
        # Partición OK pero sin instalación
        motivo="sin_instalar"
    fi
else
    # No se montó la partición
    motivo="sin_particion"
fi

# Si hay motivo, ejecutamos instalador
if [ -n "${motivo-}" ]; then
    caso="$motivo"
    [ "$caso" = "sin_particion" ] && msg="no se pudo montar la partición"
    [ "$caso" = "sin_instalar" ]  && msg="no existe una instalación de WolfbearOS"
    echo "[initramfs] Lanzando instalador: $msg."
    sh /install/run || echo "[initramfs] La instalación falló"
fi

# Bucle para mantener consola activa
for port in tty1 ttyAMA0; do
  if [ -e "/dev/$port" ]; then
    echo "[initramfs] WolfbearOS getty en $port"
    /sbin/getty -L "$port" 115200 vt100 &
  fi
done

# Esperar indefinidamente (para evitar que PID 1 muera)
wait