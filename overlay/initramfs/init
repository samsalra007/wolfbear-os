#!/bin/sh

echo "[initramfs] Inicializando sistemas virtuales..."
mkdir -p /proc /sys /dev

mount -t devtmpfs dev /dev
mount -t proc proc /proc
mount -t sysfs sysfs /sys

echo "[initramfs] Buscando instalación de WolfbearOS"
echo "            Montando vda-root"
mkdir -p /mnt/vda-root

echo "[initramfs] Listando discos y sus particiones"

lsblk

mount /dev/vda2 /mnt/vda-root || {
    echo "[initramfs] WolfbearOS no detectó una partición válida del sistema operativo."
    echo "            O bien, esta es la imagen de instalación. Favor de expulsarla si no"
    echo "            desea instalar el sistema."

    source /install/util-log
    exec /install/run

    echo "Instalación finaliada, por favor reinicie su equipo o bien siga probando la terminal"
}

if [ -f /mnt/vda-root/.wolfbearOSInstalled ]; then
    echo "[initramfs] WolfbearOS detectó un sistema instalado"
	exec /launch/run
else
    echo "[initramfs] WolfbearOS detectó un disco pero no contiene el sistema operativo."
    echo "            O bien, esta es la imagen de instalación. Favor de expulsarla si no"
    echo "            desea instalar el sistema."

    source /install/util-log
    exec /install/run
fi

while true; do
    echo "WolfbearOS initramfs"

    /sbin/getty -L ttyAMA0 115200 vt1000

    echo "Woof bye!"
    sleep 2
done
