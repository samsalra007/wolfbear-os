#!/bin/sh
set -euo pipefail

# Script init para initramfs de WolfbearOS
# Monta la partición, comprueba la instalación y lanza instalador si es necesario

echo "[initramfs] Arrancando sistemas virtuales..."
mkdir -p /proc /sys /dev
mount -t devtmpfs dev /dev
mount -t proc proc /proc
mount -t sysfs sysfs /sys

# Definir punto de montaje
defined_mnt="/mnt/vda-root"
mkdir -p "$defined_mnt"

# Intento de montaje
if mount /dev/vda2 "$defined_mnt"; then
    # Si está instalado, lanzamos el sistema
    if [ -f "$defined_mnt/.wolfbearOSInstalled" ]; then
        echo "[initramfs] Sistema instalado detectado. Iniciando..."
        sh /launch/run || echo "[initramfs] Error al iniciar el sistema."
    else
        # Partición OK pero sin instalación
        motivo="sin_instalar"
    fi
else
    # No se montó la partición
    motivo="sin_particion"
fi

# Si hay motivo, ejecutamos instalador
if [ -n "${motivo-}" ]; then
    caso="$motivo"
    [ "$caso" = "sin_particion" ] && msg="no montó la partición"
    [ "$caso" = "sin_instalar" ]  && msg="no hay instalación"
    echo "[initramfs] Lanzando instalador: $msg."
    /sbin/getty -L ttyAMA0 115200 vt100
    sh /install/run || echo "[initramfs] Instalador falló."
fi

# Bucle para mantener consola activa
while true; do
    echo "[initramfs] Consola de emergencia."
    /sbin/getty -L ttyAMA0 115200 vt100
    sleep 2
done