#!/bin/sh
# format_install.sh - Formatea disco, copia overlay e instala sistema (BusyBox compatible)
# Uso: sudo ./format_install.sh

set -e

# Variables fijo
MNT_POINT="/mnt/target"
OVERLAY_DIR="./rootfs-overlay"

# 1. Selección de disco a formatear
echo "\n== Selección de disco =="
lsblk -d -o NAME,SIZE,MODEL | grep -E 'sd|vd|nvme'
read -rp "Introduce el nombre del disco a formatear (ej: sda): " DISK
DEVICE="/dev/$DISK"

# Confirmación
echo "Formatearás $DEVICE, ¡se borrarán todos los datos!"
read -rp "¿Continuar? (y/n): " CONFIRM
if [ "$CONFIRM" != "y" ]; then
    echo "Operación cancelada."
    exit 1
fi

# 2. Formatear y montar
echo "\n== Formateo y montaje =="
echo "Formateando $DEVICE como ext4..."
mkfs.ext4 -F "$DEVICE"

echo "Creando punto de montaje $MNT_POINT..."
mkdir -p "$MNT_POINT"
echo "Montando $DEVICE en $MNT_POINT..."
mount "$DEVICE" "$MNT_POINT"

# 3. Copiar overlay
echo "\n== Copiar overlay =="
if [ -d "$OVERLAY_DIR" ]; then
    echo "Overlay encontrado en $OVERLAY_DIR, copiando al target..."
    tar -C "$OVERLAY_DIR" -cf - . | tar -C "$MNT_POINT" -xf -
else
    echo "No se encontró $OVERLAY_DIR, omitiendo copia de archivos de sistema."
fi

# 4. Instalar paquetes básicos
echo "\n== Instalación de paquetes base =="
chroot "$MNT_POINT" apk update
chroot "$MNT_POINT" apk add --no-cache \
    apk-tools shadow dhcpcd openresolv util-linux strace openssh \
    sdl2 libdrm mesa-gbm mesa-dri-gallium libinput expat libffi

# 5. Configuraciones de sistema
echo "\n== Configuración del sistema =="
# Hostname
echo "myconsole" > "$MNT_POINT/etc/hostname"
# fstab
cat > "$MNT_POINT/etc/fstab" <<EOF
$DEVICE / ext4 defaults 0 1
EOF

# 6. Crear usuario y contraseña
echo "\n== Creación de usuario =="
chroot "$MNT_POINT" adduser -D user
printf "\nEstablece contraseña para 'user': "
chroot "$MNT_POINT" passwd user

# 7. Finalizar
echo "\n== Finalizando =="
sync
echo "Desmontando $MNT_POINT..."
umount "$MNT_POINT"

echo "Instalación completada exitosamente."
