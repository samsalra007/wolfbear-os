#!/bin/sh

set -euo pipefail

IMG=disk.img
SIZE_MB=512
LOOPDEV=""
MNT_DIR=/mnt/disk

# Limpiar imagen previa
echo "Eliminando imagen previa si existe..."
umount -l "$MNT_DIR/boot/efi"
umount -l "$MNT_DIR"
rm -f "$IMG"

# Crear imagen vacía
echo "Creando imagen de $SIZE_MB MiB..."
dd if=/dev/zero of="$IMG" bs=1M count=$SIZE_MB

# Asociar imagen a loop device
echo "Asociando imagen a loop device..."
LOOPDEV=$(losetup -f)
losetup "$LOOPDEV" "$IMG"

# Crear tabla GPT y particiones
echo "Creando tabla GPT y particiones..."
parted --script "$LOOPDEV" \
  mklabel gpt \
  mkpart ESP fat32 1MiB 100MiB \
  set 1 esp on \
  mkpart primary ext4 100MiB 100%

# Recargar particiones
echo "Recargando particiones..."
partprobe "$LOOPDEV"

# Reasociar loop device con particiones
echo "Reasociando loop device para detectar particiones..."
losetup -d "$LOOPDEV"
LOOPDEV=$(losetup --find --show "$IMG")
sleep 1

# Determinar dispositivos de partición
echo "Detectando particiones..."
partx -a "$LOOPDEV"
EFI_PART="${LOOPDEV}p1"
ROOT_PART="${LOOPDEV}p2"

# Formatear particiones
echo "Formateando partición EFI ($EFI_PART) como FAT32..."
mkfs.vfat -F 32 "$EFI_PART"

echo "Formateando partición root ($ROOT_PART) como ext4..."
mkfs.ext4 "$ROOT_PART"

# Montar particiones
echo "Montando particiones en /mnt/disk..."
mkdir -p "$MNT_DIR"
mount "$ROOT_PART" "$MNT_DIR"
mkdir -p "$MNT_DIR/boot/efi"
mount "$EFI_PART" "$MNT_DIR/boot/efi"

# Copiar kernel e initramfs
echo "Copiando kernel e initramfs a /mnt/disk/boot..."
mkdir -p "$MNT_DIR/boot"
cp target/Image "$MNT_DIR/boot/"
cp target/initramfs.cpio.gz "$MNT_DIR/boot/"

# Instalar EFI stub loader
# Asegúrate de compilar el kernel con CONFIG_EFI_STUB=y
echo "Instalando EFI stub loader..."
BOOTDIR="$MNT_DIR/boot/efi/EFI/BOOT"
mkdir -p "$BOOTDIR"
cp target/Image           "$BOOTDIR/BOOTAA64.EFI"
cp target/initramfs.cpio.gz "$BOOTDIR/initramfs.cpio.gz"

# Configuración opcional del loader
echo "timeout 5" > "$BOOTDIR/loader.conf"
echo "console=ttyAMA0 root=/dev/vda2 rw" > "$BOOTDIR/BOOTAA64.conf"

# Finalizar
echo "Sincronizando y desmontando..."
sync
umount "$MNT_DIR/boot/efi"
umount "$MNT_DIR"

echo "Imagen '$IMG' creada y preparada para boot EFI usando EFI stub loader."
```
