#!/bin/sh
set -euo pipefail

SCRIPT_NAME=$0

export CURRENT_PATH="$(pwd)"
export SCRIPTS_DIR="$(dirname "$0")"

doas echo "Compilación de WolfbearOS en initramfs ha empezado"

BASEDIR="$(cd "$(dirname "$0")" && pwd)"
. "$BASEDIR/globals-definitions"

echo "$WOLFBEAR_OS_DIR en run"

# Ejecutar un único script directamente si no es un 'run='
if [ -n "${1-}" ] && [ "${1%%=*}" != "run" ]; then
  SCRIPT_NAME_TO_EXECUTE="$1"
  echo "Has solicitado ejecutar el script '$SCRIPT_NAME_TO_EXECUTE'."
  sh "$SCRIPT_NAME_TO_EXECUTE"
  exit 0
fi

# Parsear lista de scripts a ejecutar en orden (formato: run=001-a,040-b)
RUN_LIST=""
if [ "${1-}" ] && echo "$1" | grep -q '^run='; then
  RUN_LIST=$(echo "$1" | cut -d'=' -f2)
fi

if [ -z "$RUN_LIST" ]; then
  echo "No se especificaron scripts con 'run='"
  exit 1
fi

echo "Has solicitado ejecutar únicamente estos scripts:"
echo "$RUN_LIST" | tr ',' '\n'
echo "scripts dir $SCRIPTS_DIR"

for script_basename in $(echo "$RUN_LIST" | tr ',' ' '); do
  script="$SCRIPTS_DIR/$script_basename"

  if [ ! -f "$script" ]; then
    echo "Script '$script_basename' no encontrado."
    continue
  fi

  if [ ! -x "$script" ]; then
    echo "Script '$script_basename' no es ejecutable. Usando sh para correrlo."
  fi

  echo
  echo "Corriendo script $script_basename"

  if echo "$script_basename" | grep -qE '^[0-9]{3}-doas-'; then
    echo "Este script requiere permisos de superusuario (doas)"
    doas sh -c '
        SCRIPT="$0"
        SCRIPTS_DIR="$(dirname "$SCRIPT")"
        . "$SCRIPTS_DIR/globals-definitions"
        . "$SCRIPTS_DIR/util-log"
        sh "$SCRIPT"
        ' "$script"

  else
    . "$script"
  fi
done

echo
echo "Compilación de WolfbearOS ha terminado"
exit 0
