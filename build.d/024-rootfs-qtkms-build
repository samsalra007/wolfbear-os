#!/bin/sh
set -euo pipefail
source "$SCRIPTS_DIR/util-log"

SCRIPT_NAME=$0
log_message $SCRIPT_NAME "Compilación del plugin EGLFS_KMS (libqeglfs-kms-integration.so) para Qt"

QT_SRC_TAR="qt-everywhere-src-$QT_VERSION.tar.xz"
QT_SRC_URL="https://download.qt.io/archive/qt/6.8/$QT_VERSION/single/$QT_SRC_TAR"

if [ ! -d "$DEPENDENCY_QT_PLUGIN_KMS" ]; then
	log_message $SCRIPT_NAME "Descargando Qt $QT_VERSION desde $QT_SRC_URL"
	mkdir -p "$DEPENDENCY_QT_PLUGIN_KMS"
	cd "$DEPENDENCY_QT_PLUGIN_KMS"

	if ! wget "$QT_SRC_URL"; then
		log_message $SCRIPT_NAME "[ERROR] Falló la descarga de $QT_SRC_TAR"
		exit 1
	fi

	debug_message $SCRIPT_NAME "Descomprimiendo archivo $QT_SRC_TAR"
	tar xf "$QT_SRC_TAR"
else
	log_message $SCRIPT_NAME "Qt $QT_VERSION ya está descomprimido en $DEPENDENCY_QT_PLUGIN_KMS"
fi

log_message $SCRIPT_NAME "Limpiando carpeta build y accediendo en ella"
new_line

rm -rf "$DEPENDENCY_QT_PLUGIN_KMS_BUILD"
mkdir -p "$DEPENDENCY_QT_PLUGIN_KMS_BUILD"
cd "$DEPENDENCY_QT_PLUGIN_KMS_BUILD"

mkdir -p "$DEPENDENCY_QT_PLUGIN_KMS_BUILD/build-qtbase"
cd "$DEPENDENCY_QT_PLUGIN_KMS_BUILD/build-qtbase"

rm -rf $OVERLAY_QT_CUSTOM
mkdir -p $OVERLAY_QT_CUSTOM

log_message $SCRIPT_NAME "Iniciando compilación de Qt base"

cmake ../../qt-everywhere-src-$QT_VERSION/qtbase -GNinja \
  -DCMAKE_INSTALL_PREFIX=/usr \
  -DCMAKE_PREFIX_PATH=/usr/lib/qt6/cmake \
  -DFEATURE_developer_build=ON \
  -DFEATURE_private_tests=ON \
  -DQT_BUILD_EXAMPLES=OFF \
  -DQT_BUILD_TESTS=OFF

ninja
DESTDIR="$OVERLAY_QT_CUSTOM" ninja install

# Copiar headers privados manualmente
PRIVATE_HEADERS_SRC_DIR="$DEPENDENCY_QT_PLUGIN_KMS_BUILD/build-qtbase/include"

if [ -d "$PRIVATE_HEADERS_SRC_DIR" ]; then
  log_message $SCRIPT_NAME "Copiando headers privados manualmente desde $PRIVATE_HEADERS_SRC_DIR"
  rsync -av "$PRIVATE_HEADERS_SRC_DIR/" "$OVERLAY_QT_CUSTOM/usr/include/qt6/"
else
  log_message $SCRIPT_NAME "[WARN] No se encontraron headers privados en $PRIVATE_HEADERS_SRC_DIR"
fi

log_message $SCRIPT_NAME "Iniciando compilación de módulos Qt adicionales"

for module in $QT_MODULES; do
  MODULE_BUILD_DIR="$DEPENDENCY_QT_PLUGIN_KMS_BUILD/build-$module"

  if [ -d "$DEPENDENCY_QT_PLUGIN_KMS/qt-everywhere-src-$QT_VERSION/$module" ]; then
    log_message $SCRIPT_NAME "Compilando módulo $module"
    mkdir -p "$MODULE_BUILD_DIR"
    cd "$MODULE_BUILD_DIR"

    cmake ../../qt-everywhere-src-$QT_VERSION/$module -GNinja \
      -DCMAKE_INSTALL_PREFIX=/usr \
      -DCMAKE_PREFIX_PATH=/usr/lib/qt6/cmake \
      -DQT_BUILD_EXAMPLES=OFF \
      -DQT_BUILD_TESTS=OFF

    ninja
    DESTDIR="$OVERLAY_QT_CUSTOM" ninja install
  else
    log_message $SCRIPT_NAME "[WARN] Módulo $module no encontrado en el tarball, se omite"
  fi
done

