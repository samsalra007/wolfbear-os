#!/bin/sh
set -euo pipefail
source "$SCRIPTS_DIR/util-log"

SCRIPT_NAME=$0
log_message $SCRIPT_NAME "Compilación del plugin EGLFS_KMS (libqeglfs-kms-integration.so) para Qt"

QT_SRC_TAR="qt-everywhere-src-$QT_VERSION.tar.xz"
QT_SRC_URL="https://download.qt.io/archive/qt/6.8/$QT_VERSION/single/$QT_SRC_TAR"

if [ ! -d "$DEPENDENCY_QT_PLUGIN_KMS" ]; then
	log_message $SCRIPT_NAME "Descargando Qt $QT_VERSION desde $QT_SRC_URL"
	mkdir -p "$DEPENDENCY_QT_PLUGIN_KMS"
	cd "$DEPENDENCY_QT_PLUGIN_KMS"

	if ! wget "$QT_SRC_URL"; then
		log_message $SCRIPT_NAME "[ERROR] Falló la descarga de $QT_SRC_TAR"
		exit 1
	fi

	debug_message $SCRIPT_NAME "Descomprimiendo archivo $QT_SRC_TAR"
	tar xf "$QT_SRC_TAR"
else
	log_message $SCRIPT_NAME "Qt $QT_VERSION ya está descomprimido en $DEPENDENCY_QT_PLUGIN_KMS"
fi

log_message $SCRIPT_NAME "Limpiando carpeta build y accediendo en ella"
new_line

rm -rf "$DEPENDENCY_QT_PLUGIN_KMS_BUILD"
mkdir -p "$DEPENDENCY_QT_PLUGIN_KMS_BUILD"
cd "$DEPENDENCY_QT_PLUGIN_KMS_BUILD"

rm -rf "$OVERLAY_QT_CUSTOM"
mkdir -p "$OVERLAY_QT_CUSTOM"

# --- Compilar Qt Base ---
mkdir -p build-qtbase
cd build-qtbase

log_message $SCRIPT_NAME "Iniciando compilación de Qt base"

cmake ../../qt-everywhere-src-$QT_VERSION/qtbase -GNinja \
  -DCMAKE_INSTALL_PREFIX=/usr \
  -DCMAKE_PREFIX_PATH="$OVERLAY_QT_CUSTOM/usr/lib/qt6/cmake" \
  -DCMAKE_FIND_ROOT_PATH="$OVERLAY_QT_CUSTOM" \
  -DFEATURE_developer_build=ON \
  -DFEATURE_private_tests=ON \
  -DQT_BUILD_EXAMPLES=OFF \
  -DQT_BUILD_TESTS=OFF

ninja -j"$(nproc)"
DESTDIR="$OVERLAY_QT_CUSTOM" ninja install

log_message $SCRIPT_NAME "Reubicando plugins"
# --- Reubicar plugins si es necesario ---
if [ -d "$OVERLAY_QT_CUSTOM/usr/plugins" ]; then
  log_message $SCRIPT_NAME "Corrigiendo ubicación de plugins al estilo Alpine"
  mkdir -p "$OVERLAY_QT_CUSTOM/usr/lib/qt6/plugins"
  mv "$OVERLAY_QT_CUSTOM/usr/plugins/"* "$OVERLAY_QT_CUSTOM/usr/lib/qt6/plugins/"
  rmdir "$OVERLAY_QT_CUSTOM/usr/plugins" || true
fi

log_message $SCRIPT_NAME "Reubicando cabeceras"
# --- Reubicar headers si es necesario ---
if [ -d "$OVERLAY_QT_CUSTOM/usr/include" ]; then
  log_message $SCRIPT_NAME "Corrigiendo ubicación de headers al estilo Alpine"
  mkdir -p "$OVERLAY_QT_CUSTOM/usr/include/qt6"
  for item in "$OVERLAY_QT_CUSTOM/usr/include/"*; do
    [ "$(basename "$item")" = "qt6" ] && continue
    mv "$item" "$OVERLAY_QT_CUSTOM/usr/include/qt6/"
  done
fi

log_message $SCRIPT_NAME "Compilación finalizada. Qt base con EGLFS_KMS lista en $OVERLAY_QT_CUSTOM"
