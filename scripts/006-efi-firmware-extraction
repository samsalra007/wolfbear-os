#!/bin/sh
set -euo pipefail

echo "[efi-firmware] Starting efi firmware extraction from Debian"

# Directorio donde descargar y extraer dependencias
dep_path="${DEPENDENCIES_PATH:-./dependencies}"

# Crear directorio de trabajo
echo "Preparando directorio: $dep_path"
mkdir -p "$dep_path"
cd "$dep_path"

# 1. Descargar .deb
pkg="qemu-efi-aarch64_2024.01-1_all.deb"
url="https://deb.debian.org/debian/pool/main/q/qemu-efi/$pkg"

echo "Descargando paquete: $url"
wget -O "$pkg" "$url" || {
  echo "Error: no se pudo descargar el paquete desde $url" >&2
  exit 1
}

# 2. Verificar que el archivo no esté vacío
if [ ! -s "$pkg" ]; then
  echo "Error: el archivo $pkg está vacío" >&2
  exit 1
fi

# 3. Instalar dpkg si no está disponible
command -v dpkg-deb >/dev/null 2>&1 || apk add --no-cache dpkg

# 4. Extraer .deb usando dpkg-deb
echo "Extrayendo contenido del .deb..."
dpkg-deb -x "$pkg" .

# 5. Ubicar firmware
echo "Buscando firmware .fd en usr/share..."
firmware_path=$(find usr/share -type f -name '*.fd' | head -n1)
if [ -z "$firmware_path" ]; then
  echo "Error: no se encontró ningún archivo .fd" >&2
  exit 1
fi

echo "Firmware encontrado: $firmware_path"

# 6. Instalar en Alpine
echo "Instalando firmware en: $install_dir"
install -Dm644 "$firmware_path" "$install_dir/QEMU_EFI.fd"

# 7. Copiar a destino
mkdir -p "$TARGET_PATH"
echo "Copiando firmware a: $TARGET_PATH"
cp "$install_dir/QEMU_EFI.fd" "$TARGET_PATH/"

# 8. Final
echo "Firmware listo en $TARGET_PATH/QEMU_EFI.fd"

echo "[efi-firmware] extraction finished"

