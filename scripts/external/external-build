#!/bin/sh
set -euo pipefail

EXTERNAL_PATH="$PROJECT_PATH/external"

echo "- External path: '$EXTERNAL_PATH'"
sleep 0.5

echo "- Overlay path: '$OVERLAY_PATH'"
sleep 0.5

# 2) Sincronizar overlay
echo "- Syncing overlay path to external path"
rsync -a --links "$OVERLAY_PATH/" "$EXTERNAL_PATH/"

# 3) Preparar directorios
echo "- Preparing ./external directories"
sleep 0.5

mkdir -p \
  "$EXTERNAL_PATH/tmp" \
  "$EXTERNAL_PATH/sbin" \
  "$EXTERNAL_PATH/lib/apk/db" \
  "$EXTERNAL_PATH/etc/apk" \
  "$EXTERNAL_PATH/etc/ssl/certs" \
  "$EXTERNAL_PATH/usr/lib"

echo "- Copying keys and repositories from local apk"
sleep 0.5
cp -r /etc/apk/keys $EXTERNAL_PATH/etc/apk/keys
cp /etc/apk/repositories $EXTERNAL_PATH/etc/apk/repositories

echo "- Installing apk tools in ./external"
sleep 0.5

sudo /sbin/apk --root "$EXTERNAL_PATH" \
  --initdb \
  --keys-dir /etc/apk/keys \
  --repositories-file /etc/apk/repositories \
  add \
    apk-tools \
    shadow \
    dhcpcd \
    openresolv \
    util-linux \
    strace \
    mesa-gl \
    mesa-egl \
    mesa-gbm \
    libdrm \
    musl \
    musl-dev \
    openssh \
    mesa-dri-gallium \
    sdl2 \
    expat expat-dev \
    libffi libffi-dev

echo "- Setting up root user"
sleep 0.5
echo 'root:x:0:0:root:/root:/bin/sh' >> $EXTERNAL_PATH/etc/passwd
echo 'root::14600:0:99999:7:::' >> $EXTERNAL_PATH/etc/shadow

# echo "nameserver 8.8.8.8" > $EXTERNAL_PATH/etc/resolv.conf
sudo chmod u+s $EXTERNAL_PATH/bin/ping

# echo "- Adding resol.conf from local alpine"
# cp /etc/resolv.conf "$EXTERNAL_PATH/etc/resolv.conf"

