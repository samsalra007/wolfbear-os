#!/bin/bash

echo "[STEP BEGIN] pkg-external-dependencies-alpine-docker"
sleep 1

echo "  Verifying required paths exist"
sleep 1
mkdir -p $PKG_EXTERNAL_PATH/usr/include $PKG_EXTERNAL_PATH/usr/lib


echo "  Running Docker Image"
sleep 1

echo "  PKG_EXTERNAL_PATH="$PKG_EXTERNAL_PATH
sleep 1

docker run --rm -v "${PKG_EXTERNAL_PATH}":/target alpine:3.18 sh -euxc '
  apk update
  apk add --no-cache \
    musl-dev           \  # headers libc, libm, etc.
    sdl2-dev           \  # SDL2 (runtime + headers)
    file               \  # para identificar binarios
    binutils pkgconf       # ldd/readelf, pkg-config

  # Copiar encabezados estándar
  rm -rf /target/usr/include
  mkdir /target/usr/include

  cp -a /usr/include       /target/usr/

  # Copiar Librerias No Estandar
  cp -a /usr/include/SDL2	/target/usr/include/
  cp -a /usr/lib/libSDL2*	/target/usr/lib/
  cp -a /usr/lib/libdrm*	/target/usr/lib/
  cp -a /usr/lib/libEGL*	/target/usr/lib/
  cp -a /usr/lib/libGL*	/target/usr/lib/
  cp -a /usr/lib/libgbm*	/target/usr/lib/

  # Copiar SOLO la biblioteca real de libudev
  REALUDEV=$(readlink -f /lib/libudev.so.1)
  cp -a "$REALUDEV" /target/lib/

  # Crear enlaces simbólicos correctos dentro del rootfs
  cd /target/usr/lib
  ln -sf ../../lib/$(basename "$REALUDEV") libudev.so.1
  ln -sf libudev.so.1 libudev.so

  # Copiar libc y loader dinámico (que traen libm, stdio, etc.)
  mkdir -p /target/lib
  cp -a /lib/libc.musl-*.so.1	/target/lib/libc.so.1
  cp -a /lib/ld-musl-*.so.1     /target/lib/

  # (Opcional) si necesitas la libc estática (.a)
  cp -a /usr/lib/libc.a       /target/usr/lib/

  # Copiar herramienta 'file' y sus dependencias
  mkdir -p /target/usr/bin /target/usr/lib /target/usr/share/misc
  cp -a /usr/bin/file /target/usr/bin/
  cp -a /usr/lib/libmagic.so* /target/usr/lib/
  cp -a /usr/share/misc/magic.mgc /target/usr/share/misc/

  # Copiar herramienta 'ldd' y dependencias
  cp -a /usr/bin/ldd /target/usr/bin/
  cp -a /usr/bin/readelf /target/usr/bin/

  echo "--- Dentro del contenedor, /target/lib contiene:" && ls /target/lib
  echo "--- Dentro del contenedor, /target/usr/lib contiene:" && ls /target/usr/lib
'

# Activar según la GPU, Por el momento no se activa, y hay que añadir mesa-vulkan en las dependencias
# ICDs (implementaciones de Vulkan para hardware específico, ej: mesa)
# cp -a /usr/lib/libvulkan_intel.so* /target/usr/lib/ 2>/dev/null || true
# cp -a /usr/lib/libvulkan_radeon.so* /target/usr/lib/ 2>/dev/null || true
# cp -a /usr/lib/libvulkan_lvp.so* /target/usr/lib/ 2>/dev/null || true
# cp -a /usr/lib/libvulkan_swrast.so* /target/usr/lib/ 2>/dev/null || true

echo "  Checking dependencies installed"
sleep 1
# ls $PKG_EXTERNAL_PATH/usr/include/SDL2
ls $PKG_EXTERNAL_PATH/usr/lib

echo "[STEP END] pkg-external-dependencies-alpine-docker"
sleep 1
