#!/bin/sh
set -euo pipefail

EXTERNAL_PATH="$PROJECT_PATH/external"

echo "- External path: '$EXTERNAL_PATH'"
sleep 0.5

echo "- Overlay path: '$OVERLAY_PATH'"
sleep 0.5

# 2) Sincronizar overlay
echo "- Syncing overlay path to external path"
rsync -a --links "$OVERLAY_PATH/" "$EXTERNAL_PATH/"

# 3) Preparar directorios
echo "- Preparing ./external directories"
sleep 0.5

mkdir -p \
  "$EXTERNAL_PATH/tmp" \
  "$EXTERNAL_PATH/sbin" \
  "$EXTERNAL_PATH/lib/apk/db" \
  "$EXTERNAL_PATH/etc/apk" \
  "$EXTERNAL_PATH/etc/ssl/certs" \
  "$EXTERNAL_PATH/usr/lib"

echo "- Copying keys and repositories from local apk"
sleep 0.5
cp -r /etc/apk/keys $EXTERNAL_PATH/etc/apk/keys
cp /etc/apk/repositories $EXTERNAL_PATH/etc/apk/repositories

echo "Installing apk tools in ./external"
sleep 0.5

sudo /sbin/apk --root "$EXTERNAL_PATH" \
  --initdb \
  --keys-dir /etc/apk/keys \
  --repositories-file /etc/apk/repositories \
  add apk-tools strace

echo "- Adding resol.conf from local alpine"
[ -f /etc/resolv.conf ] && cp /etc/resolv.conf "$EXTERNAL_PATH/etc/resolv.conf"
