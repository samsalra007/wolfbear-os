#!/bin/bash

echo "[STEP BEGIN] pkg-external-dependencies-alpine-docker"
sleep 1

echo "  External path found: "${PKG_EXTERNAL_PATH}
sleep 1

docker run --rm -v "$PKG_EXTERNAL_PATH":/target alpine:3.18 sh -euxc '
  apk update
  apk add --no-cache \
    musl-dev sdl2-dev file binutils pkgconf libmagic \
    eudev-dev mesa-gbm mesa-gl mesa-dri-gallium mesa-egl rsync \
    libdrm-dev mesa-dev \
    wayland-dev expat-dev \
    libffi-dev

  # Limpia y crea directorios base
  rm -rf /target/{usr/{include,lib},lib}
  mkdir -p /target/usr/{include,lib,bin,share/misc} /target/lib

  # 1⃣ Copia TODO /usr/include en target/usr/include
  rsync -a --links /usr/include/ /target/usr/include/

  # 2⃣ Copia librerías dinámicas
  rsync -a --links /usr/lib/libSDL2*   /target/usr/lib/
  rsync -a --links /usr/lib/libdrm*    /target/usr/lib/
  rsync -a --links /usr/lib/libgbm*    /target/usr/lib/
  rsync -a --links /usr/lib/libEGL*    /target/usr/lib/
  rsync -a --links /usr/lib/libGL*     /target/usr/lib/
  rsync -a --links /usr/lib/libmagic.* /target/usr/lib/
  rsync -a --links /usr/lib/libwayland-server.so* /target/usr/lib/
  rsync -a --links /usr/lib/libexpat.so*         /target/usr/lib/
  rsync -a --links /usr/lib/libffi.so*          /target/usr/lib/

  # 3⃣ Copia loader y libc musl
  rsync -a --links /lib/libc.musl-*.so.1 /target/lib/
  rsync -a --links /lib/ld-musl-*.so.1   /target/lib/

  # 4⃣ (Opcional) copia la libc estática si la necesitas
  cp -a /usr/lib/libc.a /target/usr/lib/ || true

  # 5⃣ Copia utilidades (sin comillas en llaves)
  rsync -a --links /usr/bin/file /target/usr/bin/
  rsync -a --links /usr/bin/ldd /target/usr/bin/
  # rsync -a --links /usr/bin/readelf /target/usr/bin/

  # 6⃣ Base de datos de magic
  mkdir -p /target/usr/share/misc
  cp -a /usr/share/misc/magic.mgc /target/usr/share/misc/

  # Ajusta permisos
  chmod -R u+rwX /target

  echo "=== pkg-external listo ==="
'

# Activar según la GPU, Por el momento no se activa, y hay que añadir mesa-vulkan en las dependencias
# ICDs (implementaciones de Vulkan para hardware específico, ej: mesa)
# cp -a /usr/lib/libvulkan_intel.so* /target/usr/lib/ 2>/dev/null || true
# cp -a /usr/lib/libvulkan_radeon.so* /target/usr/lib/ 2>/dev/null || true
# cp -a /usr/lib/libvulkan_lvp.so* /target/usr/lib/ 2>/dev/null || true
# cp -a /usr/lib/libvulkan_swrast.so* /target/usr/lib/ 2>/dev/null || true

echo "[STEP END] pkg-external-dependencies-alpine-docker"
sleep 1
