#!/bin/sh
set -euo pipefail
source $SCRIPTS_DIR/util-log

SCRIPT_NAME=$0

log_message $SCRIPT_NAME "Generando imagen de disco '$INITRAMFS_INSTALLER_DIR'"

LOOPDEV=""

echo "Desmontando cualquier montaje previo en '$DISK_IMAGE_MOUNT_DIR'"
umount -l "$DISK_IMAGE_MOUNT_EFI_DIR" || true
umount -l "$DISK_IMAGE_MOUNT_ROOTFS_DIR" || true
umount -l "$DISK_IMAGE_MOUNT_RESOURCES_DIR" || true

rm -f "$DISK_IMAGE_NAME_DIR_IMG"

echo "Creating blank disk image of size ${DISK_IMAGE_SIZE}MB at '$DISK_IMAGE_NAME'"
dd if=/dev/zero of="$DISK_IMAGE_NAME" bs=1M count=$DISK_IMAGE_SIZE

echo "Associating loop device with disk image"
LOOPDEV=$( losetup -f)
losetup "$LOOPDEV" "$DISK_IMAGE_NAME"

echo "Creating GPT partition table and partitions on '$LOOPDEV'"
parted --script "$LOOPDEV" \
  mklabel gpt \
  mkpart ESP fat32 1MiB 100MiB \
  set 1 esp on \
  mkpart primary ext4 100MiB 200MiB \
  mkpart primary ext4 200MiB 100%

echo "Refreshing partition table"
partprobe "$LOOPDEV"

echo "Detaching loop device"
losetup -d "$LOOPDEV"
LOOPDEV=$( losetup --find --show "$DISK_IMAGE_NAME" )

echo "Re-attaching partitions to loop device"
partx -a "$LOOPDEV"
EFI_PART="${LOOPDEV}p1"
ROOT_PART="${LOOPDEV}p2"
RESOURCES_PART="${LOOPDEV}p3"

echo "Formatting partitions for EFI as FAT32, ROOT as ext4, and RESOURCES as ext4"
mkfs.vfat -F 32 "$EFI_PART"
fatlabel "$EFI_PART" WBI_EFI_SYS

mkfs.ext4 "$ROOT_PART"
e2label "$ROOT_PART" WBI_ROOT

mkfs.ext4 "$RESOURCES_PART"
e2label "$RESOURCES_PART" WBI_RES

echo "Mounting partitions to '$DISK_IMAGE_MOUNT_DIR'"
EFI_BOOTDIR="$DISK_IMAGE_MOUNT_DIR/EFI_SYSTEM_PARTITION/EFI/BOOT"
EFI_SYSTEM_PARTITION="$DISK_IMAGE_MOUNT_DIR/EFI_SYSTEM_PARTITION"

ROOTFS_SYSTEM_PARTITION="$DISK_IMAGE_MOUNT_DIR/ROOTFS_FILESYSTEM_PARTITION"
ROOTFS_BOOTDIR="$DISK_IMAGE_MOUNT_DIR/ROOTFS_FILESYSTEM_PARTITION/boot"

RESOURCES_PART_DIR="$DISK_IMAGE_MOUNT_DIR/RESOURCES"

mkdir -p "$EFI_SYSTEM_PARTITION"
mount "$EFI_PART" "$EFI_SYSTEM_PARTITION"
mkdir -p "$EFI_BOOTDIR"

mkdir -p "$ROOTFS_SYSTEM_PARTITION"
mount "$ROOT_PART" "$ROOTFS_SYSTEM_PARTITION"
mkdir -p "$ROOTFS_BOOTDIR"

mkdir -p "$RESOURCES_PART_DIR"
mount "$RESOURCES_PART" "$RESOURCES_PART_DIR"

echo "Preparing GRUB EFI bootloader according to system architecture"

if [ "$SYS_ARCH" = "arm64" ]; then
    GRUB_TARGET="arm64-efi"
    GRUB_EFI_NAME="BOOTAA64.EFI"
    CONSOLE_DEVICE="ttyAMA0"
    IMAGE_NAME="wolfbear-kernel_amd64"
elif [ "$SYS_ARCH" = "aarch64" ]; then
    GRUB_TARGET="x86_64-efi"
    GRUB_EFI_NAME="BOOTX64.EFI"
    CONSOLE_DEVICE="ttyS0"
    IMAGE_NAME="wolfbear-kernel_aarch64"
else
    echo "Unsupported architecture: $SYS_ARCH"
    exit 1
fi

echo "Generating GRUB EFI binary at '$EFI_BOOTDIR/$GRUB_EFI_NAME'"

grub-mkimage \
  -O "$GRUB_TARGET" \
  -p "/EFI/BOOT" \
  -o "$EFI_BOOTDIR/$GRUB_EFI_NAME" \
  part_gpt fat ext2 normal configfile linux cpio gfxterm all_video

echo "Creating GRUB configuration file at '$EFI_BOOTDIR/grub.cfg'"
cat > "$EFI_BOOTDIR/grub.cfg" <<EOF
set timeout=0
set default=0

menuentry "WolfbearOS ($SYS_ARCH)" {
    linux (hd0,gpt2)/boot/$IMAGE_NAME console=tty0 fbcon=map:0 root=/dev/ram0 rw 
    initrd (hd0,gpt2)/boot/initramfs.in.cpio.xz
}
EOF

echo "Creating EFI startup script at '$EFI_BOOTDIR/startup.nsh'"
cat > "$EFI_BOOTDIR/startup.nsh" <<EOF
fs0:\\EFI\\BOOT\\$GRUB_EFI_NAME
EOF

echo "Copying kernel and initramfs to boot directory at '$ROOTFS_BOOTDIR'"
mkdir -p "$ROOTFS_BOOTDIR"
cp $LINUX_KERNEL_DEPENDENCY_DIR/$IMAGE_NAME $ROOTFS_BOOTDIR
cp $INITRAMFS_OUTPUT_DIR/initramfs.in.cpio.xz $ROOTFS_BOOTDIR

echo "Preparing RESOURCES partition with necessary directories and files"
mkdir -p "$RESOURCES_PART_DIR/rootfs"
mkdir -p "$RESOURCES_PART_DIR/busybox"
mkdir -p "$RESOURCES_PART_DIR/linux"

echo "Copying rootfs overlay and busybox to RESOURCES partition"
rsync -a --links "$ROOTFS_OVERLAY_DIR/" "$RESOURCES_PART_DIR/rootfs/"
rsync -a --links "$BUSYBOX_DEPENDENCY_DIR/" "$RESOURCES_PART_DIR/busybox/"

echo "Copying kernel and initramfs to RESOURCES partition"
cp $LINUX_KERNEL_DEPENDENCY_DIR/$IMAGE_NAME "$RESOURCES_PART_DIR/linux"
cp $INITRAMFS_OUTPUT_DIR/initramfs.in.cpio.xz "$RESOURCES_PART_DIR/linux"
cp $INITRAMFS_OUTPUT_DIR/initramfs.la.cpio.xz "$RESOURCES_PART_DIR/linux"

echo "Unmounting partitions from '$DISK_IMAGE_MOUNT_DIR'"
umount -l "$DISK_IMAGE_MOUNT_DIR/EFI_SYSTEM_PARTITION" || true
umount -l "$DISK_IMAGE_MOUNT_DIR/ROOTFS_FILESYSTEM_PARTITION" || true
umount -l "$DISK_IMAGE_MOUNT_DIR/RESOURCES" || true

chown wolfbear:wolfbear $DISK_IMAGE_NAME_DIR_IMG

echo "Disk image creation completed successfully: '$DISK_IMAGE_NAME_DIR_IMG'"
