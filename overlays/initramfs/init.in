#!/bin/sh
set -eu

# si el shell soporta pipefail, lo activamos; si no, no pasa nada
set -o pipefail 2>/dev/null || true

echo "[DBG] PATH=$PATH"
echo "[DBG] busybox: $(ls -l /bin/busybox 2>/dev/null || echo MISSING)"

for x in sh cat sed tr seq blkid grep head cut mount switch_root; do
  if command -v "$x" >/dev/null 2>&1; then
    echo "[DBG] $x -> $(command -v "$x")"
  else
    echo "[DBG] MISSING: $x"
  fi
done

# prueba explícita de applets
/bin/busybox --list | grep -E '^(cat|sed|seq)$' || true

sleep 5


echo "Bienvenido al script de instalación de WolfbearOS"
echo "  Montando particiones del sistema"

mkdir -p /proc /sys /dev
mount -t devtmpfs devtmpfs /dev
mount -t proc proc /proc
mount -t sysfs sysfs /sys

echo "  Detalles del sistema: "

export WOLFBEAR_OS_PRODUCT_NAME=$( cat /sys/class/dmi/id/product_name 2>/dev/null | tr -d '\r' )
export WOLFBEAR_OS_SYS_VENDOR=$( cat /sys/class/dmi/id/sys_vendor )
export WOLFBEAR_OS_PARTITION_TIMEOUT=10
export WOLFBEAR_OS_CONSOLE_PORTS="tty1 ttyAMA0"

case "$WOLFBEAR_OS_PRODUCT_NAME" in
    *QEMU*|*KVM*|*VirtualBox*|*VMware*|*Bochs*|*Xen*|*Hyper-V*|*Parallels*|*Apple\ Virtual*)
        export WOLFBEAR_OS_IS_VIRTUALIZED="true"
        ;;
    *)
        export WOLFBEAR_OS_IS_VIRTUALIZED="false"
        ;;
esac

echo "    product_name: $WOLFBEAR_OS_PRODUCT_NAME"
echo "    sys_vendor:   $WOLFBEAR_OS_SYS_VENDOR"
echo "    is_virtualized: $WOLFBEAR_OS_IS_VIRTUALIZED"
echo "    console_ports: $WOLFBEAR_OS_CONSOLE_PORTS"
echo "    partition_timeout: $WOLFBEAR_OS_PARTITION_TIMEOUT seconds"

echo "Abriendo consolas de sistema"
sleep 2

if [ -f /etc/hostname ]; then
  hostname "$(cat /etc/hostname)"
fi

clear

for port in $WOLFBEAR_OS_CONSOLE_PORTS; do
  if [ -e "/dev/$port" ]; then
    echo "[initramfs] Consola disponible en $port"
    /sbin/getty -L "$port" 115200 vt100 &
  fi
done

wait