#!/bin/sh
set -euo pipefail

QT_VERSION=6.9.1
export SYS_ARCH=$(uname -m)
if [ "$SYS_ARCH" = 'aarch64' ] || [ "$SYS_ARCH" = 'arm64' ]; then
    SYS_ARCH='arm64'
else 
    SYS_ARCH='amd64'
fi

echo "[+] Instalando utilidades básicas del sistema..."
apk add \
    util-linux \
    zip unzip \
    nano \
    parted \
    e2fsprogs \
    e2fsprogs-extra \
    dosfstools \
    xfsprogs \
    diffutils \
    grub-efi \
    linux-headers \
    xmlstarlet \
    rsync \
    git

echo "[+] Instalando herramientas para desarrollo en C/C++ y sistema de build..."
apk add \
    perl \
    gawk \
    bc \
    openssl-dev \
    build-base \
    cmake \
    ninja \
    pkgconf \
    flex \
    bison \
    elfutils-dev \
    ncurses-dev

echo "[+] Instalando dependencias Qt6 necesarias para framebuffer + KMS/DRM..."
apk add \
    qt6-qtbase-dev \
    qt6-qtdeclarative-dev \
    qt6-qtshadertools-dev \
    qt6-qtquicktimeline-dev \
    qt6-qtbase-x11 \
    mesa-dev \
    libxkbcommon-dev \
    libinput-dev \
    eudev-dev \
    freetype-dev \
    harfbuzz-dev \
    fontconfig-dev \
    libjpeg-turbo-dev \
    libpng-dev \
    zlib-dev \
    glib-dev \
    double-conversion-dev

echo "[+] Corrigiendo symlinks faltantes de ncurses (BusyBox fix para menuconfig)..."
mkdir -p /usr/include/ncursesw
for header in curses.h ncurses.h termcap.h unctrl.h; do
    ln -sf /usr/include/$header /usr/include/ncursesw/$header
done

echo "[+] Generando enlaces simbólicos para Qt $QT_VERSION..."
mkdir -p /usr/include/qt6/QtQml/$QT_VERSION
ln -sf /usr/include/qt6/QtQml /usr/include/qt6/QtQml/$QT_VERSION/QtQml

mkdir -p /usr/include/qt6/QtCore/$QT_VERSION
ln -sf /usr/include/qt6/QtCore /usr/include/qt6/QtCore/$QT_VERSION/QtCore

echo "[✔] Todas las dependencias han sido instaladas y configuradas correctamente para soporte EGLFS con KMS/DRM (eglfs_kms) en Qt $QT_VERSION."
