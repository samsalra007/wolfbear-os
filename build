#!/bin/sh
set -euo pipefail

echo "Welcome to wolfbearOS development build script"

PROJECT_PATH=$(pwd)

BUILD_SCRIPTS_PATH=$PROJECT_PATH/build-scripts
CONFIG_FILES_PATH=$PROJECT_PATH/config
DEPENDENCIES_PATH=$PROJECT_PATH/dependencies
PATCHES_PATH=$PROJECT_PATH/patches
TARGET_PATH=$PROJECT_PATH/target
EXTERNAL_PATH=$PROJECT_PATH/external

LINUX_KERNEL_VERSION=6.1
LINUX_KERNEL_PATH=$DEPENDENCIES_PATH/linux

BUSY_BOX_VERSION=1.37.0
BUSY_BOX_PATH=$DEPENDENCIES_PATH/busybox

OVERLAY_PATH=$PROJECT_PATH/overlay
ROOTFS_PATH=$PROJECT_PATH/rootfs

BUILD_ARCH=arm64
BUILD_CROSS_COMPILE=aarch64-linux-gnu-

OVERLAY_APPS_PATH=$OVERLAY_PATH/apps

# Variables por defecto
VAR_CLEANUP='n'
VAR_COMPILE_LINUX_KERNEL='n'
VAR_COMPILE_LINUX_KERNEL_MENUCONFIG='n'
VAR_COMPILE_BUSYBOX='n'
VAR_COMPRESS_ROOTFS='n'
VAR_EXTERNAL_PATH='n'

# Procesar argumentos
while [[ "$#" -gt 0 ]]; do
    case "$1" in
        -c|--cleanup)
            VAR_CLEANUP='y'
	    shift
            ;;
        -lk|--linux-kernel)
            VAR_COMPILE_LINUX_KERNEL='y'
            shift
            ;;
        -lc|--linux-menuconfig)
            VAR_COMPILE_LINUX_KERNEL_MENUCONFIG='y'
            shift
            ;;
        -b|--busybox)
            VAR_COMPILE_BUSYBOX='y'
            shift
            ;;
        -ep|--external-path)
            VAR_EXTERNAL_PATH='y'
            shift
	    ;;
        -c|--compress-rootfs)
            VAR_COMPRESS_ROOTFS='y'
            shift
            ;;
    esac
done

mkdir -p $DEPENDENCIES_PATH

if [ "$VAR_CLEANUP" = 'y' ]; then
	echo "[BUILD] Starting cleanup ./rootfs and ./target path"
	sleep 1

	cd $BUILD_SCRIPTS_PATH
	source ./wolfbear/wolfbear-cleanup	

	echo "[BUILD] Cleanup finished ./rootfs"
	sleep 1
fi

if [ "$VAR_COMPILE_LINUX_KERNEL" = 'y' ]; then
	echo "[BUILD] Compiling and patching linux kernel"
	sleep 1

	cd $BUILD_SCRIPTS_PATH
	if [ "$VAR_COMPILE_LINUX_KERNEL_MENUCONFIG" = 'y' ]; then
		source ./linux/linux-kernel-setup menuconfig
	else
		source ./linux/linux-kernel-setup oldconfig
	fi
	echo "[BUILD] Linux kernel was patched successfully"
	sleep 1
fi


if [ "$VAR_COMPILE_BUSYBOX" = 'y' ]; then
	echo "[BUILD] Linux busybox setup"
	sleep 1

	cd $BUILD_SCRIPTS_PATH
	source ./linux/linux-busybox-setup

	echo "[BUILD] Busybox was compiled successfully"
	sleep 1
fi

if [ "$VAR_EXTERNAL_PATH" = 'y' ]; then
        echo "[BUILD] ./external build started"
        sleep 1

        cd $BUILD_SCRIPTS_PATH
        source ./external/external-build

        echo "[BUILD] ./external build finished"
        sleep 1
fi

if [ "$VAR_COMPRESS_ROOTFS" = 'y' ]; then
	echo "[BUILD] Strating ./external compression"
	sleep 1

	cd $BUILD_SCRIPTS_PATH
	source ./wolfbear/wolfbear-external-package

	echo "[BUILD] Compresion of ./external finished"
	sleep 1
fi

echo "[FINISH] WolfbearOS build script process finished"
sleep 0.2
